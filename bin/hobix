#!/usr/local/bin/ruby18
require 'hobix'
require 'yaml'

module Hobix
module CommandLine
    ##
    ## Locate RC
    ##
    [ENV['HOME']].each do |home_dir|
        if File.exists? home_dir
            HOME_DIR = home_dir
            break
        end
    end
    RC = File.join( HOME_DIR, '.hobixrc' )

    SCREEN_WIDTH = 70

    def CommandLine.login
        @config = YAML::load( File.open( RC ) ) if File.exists? RC
    end

    def CommandLine.save_config
        File.open( RC, "w" ) do |f|
            f.write @config.to_yaml
        end
    end

    # Create a new skeleton for a weblog
    def CommandLine.create_weblog
    end

    # Add a weblog to local config
    def CommandLine.add_weblog( name, path )
        @config['weblogs'] ||= {}
        @config['weblogs'][name] = path
        save_config
    end

    # Delete a weblog from local config
    def CommandLine.del_weblog( name )
        @config['weblogs'] ||= {}
        @config['weblogs'].delete( name )
        save_config
    end

    ##          
    ## Setup user's RC
    ##
    def CommandLine.setup
        @config = {}

        username = ''
        default_user = ''
        user_prompt = 'Your hobix username'
        if ENV['USER']
            default_user = ENV['USER']
            user_prompt << " [<Enter> for #{ ENV['USER'] }]"
        end
        while username.empty?
            puts
            print "#{ user_prompt }: "
            username = gets.strip
            if username.empty?
                username = default_user
            end
        end
        @config['username'] = username

        puts
        puts "Your EDITOR environment variable is set to '#{ ENV['EDITOR'] }'."
        puts "You can edit entries with your EDITOR or you can just use hobix."
        print "Use your EDITOR to edit entries? [y/N]: "
        editor = gets.strip.upcase

        if editor == 'Y'
            @config['use editor'] = true
        else
            @config['use editor'] = false
        end

        # puts
        # puts "If you want to join an existing hobix weblog, we can do that now."
        # puts "Each weblog needs a name and a path.  Use <ENTER> at any prompt"
        # puts "to simply move on."
        @config['weblogs'] ||= {}
        ## XX TODO XX
    end

    def CommandLine.editor( str )
        tempfile = File.join(ENV['TMPDIR']||ENV['TMP']||ENV['TEMP']||'/tmp',"%10.6f.hobix" % Time.now())
        File.open( tempfile, "w" ) { |f| f.write str }
        system( "#{ ENV['EDITOR'] || 'vi' } #{ tempfile }" )
        return false unless File.exists?( tempfile )

        content = File.open( tempfile ).read
        File.delete( tempfile )
        content
    end
end
end

if __FILE__ == $0
    
    def print_usage
        puts "hobix #{ Hobix::VERSION } on ruby #{ ::VERSION } (#{ ::RELEASE_DATE }) [#{ ::PLATFORM }]"
        puts DATA.read
        exit
    end

    print_usage if ARGV.length < 1

    cmd, *opts = ARGV
    ARGV.clear
             
    unless Hobix::CommandLine.login
        puts "Welcome to hobix (a simple weblog tool).  Looks like your \n" +
             "first time running hobix, eh?  Time to get a bit of information \n" +
             "from you before you start using hobix.  (All of this will be stored \n"
             "in the file #{ Hobix::CommandLine::RC } if you need to edit.)\n\n"
        Hobix::CommandLine.setup
        puts    
    end

    if Hobix::CommandLine.respond_to? "#{ cmd }_weblog"
        Hobix::CommandLine.method( "#{ cmd }_weblog" ).call( *opts )
    elsif Hobix::CommandLine.respond_to? "#{ cmd }_action"
        weblog = opts.shift
        unless @config['weblogs'].has_key? weblog
            puts "*** no weblog `#{ weblog }' found in your configuration."
            puts "*** type `hobix list' and check your spelling."
            exit
        end
        hobix_weblog = Hobix::Weblog.load( @config['weblogs'][ weblog ] )
        Hobix::CommandLine.method( "#{ cmd }_action" ).call( hobix_weblog, *opts )
    else
        puts "*** no hobix command `#{ cmd }'. use `hobix' without arguments to get help."
    end

end

__END__
Usage: hobix command weblog-name [command-options]
Commands are
    create weblog-name                      Create a brand new weblog.
    add weblog-name /path/to/hobix.yaml     Adds a pre-existing hobix weblog to your list.
    edit weblog-name                        Edit weblog's configuration.
    del weblog-name                         Remove weblog from your list.

    post weblog-name shortName              Add or edit a post with identifier 'shortName'.
                                            (You can use full paths. 'blog/weddings/iWentToThisWeakWedding')
    post-list weblog-name [in/path]         List all posts and titles.
    upgen weblog-name                       Update site with only the latest changes.
    regen weblog-name                       Regenerate all pages through the site.
